<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>è·å–æ‰€æœ‰å•†å“</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-plus/2.2.17/index.css"/>
</head>
<body>
<canvas id="qrCanvas" style="display:none;"></canvas>
<div id="result"></div>
<div id="app">
    <div id="addOders" v-if="page==0">
        <el-button @click="page=1">è¿”å›å•†å“åˆ—è¡¨</el-button>
        <h4>ä½ åˆ›å»ºè®¢å•å, å¯ä»¥ç”¨æ‰‹æœºæ‘„åƒå¤´æ‰«æ</h4>
        <div id="camera">
            <el-button @click="ShowCamera()">æ‰“å¼€æ‘„åƒå¤´</el-button>
            <div id="loadingMessage">ğŸ¥ Unable to access video stream (please make sure you have a webcam enabled)</div>
            <canvas id="canvas" hidden></canvas>
            <div id="output" hidden>
                <div id="outputMessage">No QR code detected.</div>
                <div hidden><b>Data:</b> <span id="outputData"></span></div>
            </div>
        </div>
        <h4>
            å¯ä»¥é€šè¿‡åˆ†äº«->å¤åˆ¶å›¾ç‰‡, ç„¶åæŠŠå›¾ç‰‡ä¼ åˆ°è¿™é‡Œ
            <br/>
            å°†å¸®æ‚¨è‡ªåŠ¨è¯†åˆ«åˆ°å›¾ç‰‡ä¸­äºŒç»´ç çš„è®¢å•å·
            <br/>
            è¯·ç¡®å®šè®¢å•å·åç‚¹å‡»ä¸Šä¼ 
        </h4>
        <el-upload class="upload-demo" drag :http-request="GetidByQrcode">
            <div class="el-upload__text">
                Drop file here or <em>click to upload</em>
            </div>
        </el-upload>
        <h4>æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡è®¢å•å·ç›´æ¥æ·»åŠ è®¢å•:<br/>
            è®¢å•å·,å¯ä»¥åœ¨appä¸­æŸ¥è¯¢
        </h4>
        <el-row :gutter="24">
            <el-col :span="18">
                <el-input v-model="orderID" placeholder="è¾“å…¥è®¢å•ç¼–å·" />
            </el-col>
            <el-col :span="4">
                <el-button @click="AddOrder" :class="{'el-button--danger': isTips} ">ä¸Šä¼ </el-button>
            </el-col>
        </el-row>
    </div>
    <div id="allGoods" v-if="page==1">
        <el-button @click="page=0">æ·»åŠ è®¢å•</el-button>
        <el-table :data="fileterData">
            <el-table-column label="å•†å“ID" prop="goods_id"  width="80"></el-table-column>
            <el-table-column label="å•†å“åç§°" prop="goodsName"></el-table-column>
            <el-table-column label="ä»·æ ¼" prop="activityPriceGetGoods" width="100"></el-table-column>
            <el-table-column label="éœ€è¦äººæ•°" prop="customerNumWording"  width="100"></el-table-column>
            <el-table-column align="right">
                <template #header>
                    <el-input v-model="search" size="small" placeholder="Type to search"></el-input>
                </template>
                <template #default="scope">
                    <el-button size="large" @click="GetOrders(scope.$index, scope.row)">
                        æŸ¥çœ‹æ‰€æœ‰è®¢å•
                    </el-button>
                </template>
            </el-table-column>
        </el-table>
    </div>
    <div id="allOrders" v-if="page==2">
        <el-button @click="page=1">è¿”å›å•†å“åˆ—è¡¨</el-button>
        <el-table
                :data="allOrders"
                :default-sort="{ prop: 'endTimeMs', order: 'descending' }"
                style="width: 100%">
            <el-table-column label="å•†å“ID" prop="goods_id"></el-table-column>
            <el-table-column label="è®¢å•ID" prop="orderID"></el-table-column>
            <el-table-column label="è®¢å•å±äºç”¨æˆ·çš„ID" prop="userID"></el-table-column>
            <el-table-column label="ç»“æŸæ—¶é—´" sortable>
                <template #default="scope">
                    <span>{{
                        GetTime(scope.row.endTimeMs)
                        }}</span>
                </template>
            </el-table-column>
            <el-table-column label="å‰©ä½™æ—¶é—´">
                <template #default="scope">
                    <span>{{
                        LeftTime(scope.row.endTimeMs)
                    }}</span>
                </template>
            </el-table-column>
            <el-table-column align="right">
                <template #default="scope">
                    <el-button size="large" @click="GetQRCode(scope.$index, scope.row)">
                        æ˜¾ç¤ºäºŒç»´ç 
                    </el-button>
                </template>
            </el-table-column>
        </el-table>
        <el-dialog v-model="dialogTableVisible" title="è¯·æ‰“å¼€ç½‘å€æˆ–è€…æ‰«æäºŒç»´ç " width="80%" center>
            <div>
                <div>
                    äºŒç»´ç å¯¹åº”ç½‘å€ä¸º:<div>{{shareUrl}}</div>
                </div>
                <div id="ShareQR"></div>
            </div>
            <template #footer>
              <span class="dialog-footer">
                <el-button type="primary" @click="dialogTableVisible = false">ç¡®å®š</el-button>
              </span>
            </template>
        </el-dialog>
    </div>
</div>
<script src="dist_arale-qrcode_3.0.5_index.js"></script>
<script src="jsQR.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/vue/3.2.40/vue.global.prod.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/element-plus/2.2.17/index.full.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.1.2/axios.min.js"></script>
<script>
    const App = {
        data() {
            return {
                page: 1,
                allGoods: [],
                allOrders: [],
                search: "",
                orderID:"",
                qrUrl:"",
                shareUrl:"",
                isTips: false,
                dialogTableVisible: false,
            }
        },
        computed:{
            fileterData(){
                if (!this.search ) {
                    return this.allGoods
                }
                return this.allGoods.filter(
                    data => (data.goodsName+data.activityPriceGetGoods+data.customerNumWording).toLowerCase().includes(
                        this.search.toLowerCase())
                )
            }
        },
        //åœ¨å®ä¾‹ç”Ÿæˆä¹‹å‰ä¼šè‡ªåŠ¨æ‰§è¡Œçš„å‡½æ•°
        created() {
            that = this
            axios.get('/GetGoods')
                .then(function (response) {
                    if(response.status == 200){
                        for(let key in response.data){
                            that.allGoods.push(response.data[key])
                        }
                    }
                })
                .catch(function (error) {
                    console.log(error);
                });
        },
        mounted () {
            // å°†Vueæ–¹æ³•ä¼ åˆ°å…¨å±€å¯¹è±¡windowä¸­
            window.MyNotify = this.MyNotify
            window.SetOrderIDByCodeData= this.SetOrderIDByCodeData
        },
        methods:{
            ShowCamera(){
                this.$nextTick(()=>{
                    InitCameraDom()
                    OpenCamera()
                })
            },
            GetTime(time){
                if (time==undefined || time==0){
                    return "æœåŠ¡å™¨è´¦å·æœªèƒ½è·å¾—è¯¥å•†å“æ‹¼å›¢çš„æƒé™"
                }
                var unixTimestamp = new Date(time);
                return unixTimestamp.toLocaleString()
            },
            LeftTime(time){
                if (time==undefined || time==0){
                    return "æœåŠ¡å™¨è´¦å·æœªèƒ½è·å¾—è¯¥å•†å“æ‹¼å›¢çš„æƒé™"
                }
                var unixTimestamp = new Date(time);
                var now = new Date().getTime();
                var left = parseInt((time - now) /1000 / 60 / 60);
                return left + "å°æ—¶"
            },
            GetQRCode(index, order){
                this.shareUrl = "https://mobile.yangkeduo.com/group7.html?group_order_id="+order.orderID
                var codeFigure = new AraleQRCode({
                    "render":  "svg",  // ç”Ÿæˆçš„ç±»å‹ 'svg' or 'table'
                    "text": this.shareUrl, // éœ€è¦ç”ŸæˆäºŒç»´ç çš„é“¾æ¥
                    "size": 240 // ç”ŸæˆäºŒç»´ç å¤§å°
                });
                this.dialogTableVisible = true
                this.$nextTick(()=>{
                    var shareQR = document.getElementById('ShareQR');
                    shareQR.innerHTML = ""
                    shareQR.appendChild(codeFigure);
                })
            },
            GetidByQrcode(data){
                var file = data.file;
                if(window.FileReader) {
                    var fileReader = new FileReader();
                    fileReader.readAsDataURL(file);
                    fileReader.onloadend = function (event) {
                        var base64Data = event.target.result;
                        base64ToqR(base64Data)
                    }
                }
            },
            MyNotify(title, msg, type){
                if(type==""){
                    type = "info"
                }
                this.$notify({
                    title: title,
                    message: msg,
                    type: type,
                })
            },
            SetOrderIDByCodeData(qrUrl){
                var orderId = qrUrl.match(/(\d+)/g)[1]
                this.orderID = orderId
                this.isTips = true
                this.MyNotify("è¯·ç‚¹å‡»ä¸Šä¼ , åˆ†äº«è¯¥è®¢å•", "è¯†åˆ«æˆåŠŸ:" + orderId, "success");
                this.AddOrder();
            },
            GetOrders(index, good){
                axios.get('/GetOrders?good_id='+ good.goods_id)
                    .then(function (response) {
                        if(response.data instanceof Array && response.status == 200 ){
                            that.allOrders = response.data
                            that.page = 2
                        }else{
                            this.MyNotify(response.data, "")
                        }
                    })
                    .catch(function (error) {

                    });
            },
            AddOrder(){
                that = this
                axios.get('/AddOrder?order_id='+ this.orderID)
                    .then(function (response) {
                        if(response.data instanceof Array && response.status == 200 ){
                            that.allOrders = response.data
                            this.isTips = false
                            that.page = 2
                            this.MyNotify("æ·»åŠ æˆåŠŸ!", "")
                        }else{
                            this.MyNotify(response.data, "")
                        }
                    })
                    .catch(function (error) {
                        this.MyNotify("æœåŠ¡å™¨è§£æè®¢å•å¤±è´¥", "")
                    });
            }
        },
    }

    const app = Vue.createApp(App)
    app.use(ElementPlus)
    app.mount('#app')


    function base64ToqR(data) {
        var objCanvas = document.getElementById("qrCanvas");
        var ctx = objCanvas.getContext("2d"); // è¿”å›å€¼æ˜¯CanvasRenderingContext2Dç±»çš„å¯¹è±¡å®ä¾‹ã€‚

        var image = new Image();
        image.src = data;

        image.onload = function() {
            var objCanvas = document.getElementById("qrCanvas");
            objCanvas.width = image.width
            objCanvas.height = image.height
            ctx.drawImage(image, 0, 0, image.width, image.height); // ç»˜å›¾
            var imageData = ctx.getImageData(0, 0, image.width, image.height);
            // QRç è§£æ
            const code = jsQR(
                imageData.data,   // å›¾åƒæ•°æ®
                imageData.width,  // å®½åº¦
                imageData.height, // é«˜åº¦
            );
            if(code){
                SetOrderIDByCodeData(code.data)
            }else{
                MyNotify("è¯†åˆ«é”™è¯¯","äºŒç»´ç è¯†åˆ«é”™è¯¯", "error");
            }
        };
    }
    var video = document.createElement("video");
    var canvasElement = document.getElementById("canvas");
    var canvas = canvasElement.getContext("2d");
    var loadingMessage = document.getElementById("loadingMessage");
    var outputContainer = document.getElementById("output");
    var outputMessage = document.getElementById("outputMessage");
    var outputData = document.getElementById("outputData");
    function InitCameraDom(){
        video = document.createElement("video");
        canvasElement = document.getElementById("canvas");
        canvas = canvasElement.getContext("2d");
        loadingMessage = document.getElementById("loadingMessage");
        outputContainer = document.getElementById("output");
        outputMessage = document.getElementById("outputMessage");
        outputData = document.getElementById("outputData");
    }
    function drawLine(begin, end, color) {
        canvas.beginPath();
        canvas.moveTo(begin.x, begin.y);
        canvas.lineTo(end.x, end.y);
        canvas.lineWidth = 4;
        canvas.strokeStyle = color;
        canvas.stroke();
    }
    function OpenCamera(){
        // Use facingMode: environment to attemt to get the front camera on phones
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
            video.srcObject = stream;
            video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
            video.play();
            requestAnimationFrame(tick);
        });
    }


    function tick() {
        loadingMessage.innerText = "âŒ› Loading video..."
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            loadingMessage.hidden = true;
            canvasElement.hidden = false;
            outputContainer.hidden = false;

            canvasElement.height = video.videoHeight;
            canvasElement.width = video.videoWidth;
            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            var code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            if (code) {
                drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
                drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
                drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
                drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
                outputMessage.hidden = true;
                outputData.parentElement.hidden = false;
                outputData.innerText = code.data;
                outputMessage.hidden = true;
                if(code.data.indexOf("http") > -1){
                    SetOrderIDByCodeData(code.data);
                    console.log(code.data);
                    video.srcObject.getTracks()[0].stop();
                    return;
                }
            } else {
                outputMessage.hidden = false;
                outputData.parentElement.hidden = true;
            }
        }
        requestAnimationFrame(tick);
    }
</script>
</body>
</html>